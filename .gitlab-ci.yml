stages:
- lint
- build
- build-review
- review
- release

include:
- 'https://git.dbogatov.org/templates/ci-snippets/raw/master/latex-report/chktex.yml'
- 'https://git.dbogatov.org/templates/ci-snippets/raw/master/latex-report/cspell.yml'
- 'https://git.dbogatov.org/templates/ci-snippets/raw/master/latex-report/build.yml'
- 'https://git.dbogatov.org/templates/ci-snippets/raw/master/latex-report/artifacts.yml'

build-review:
  stage: build-review
  dependencies:
  - build
  script:
  - |
    docker build \
      --build-arg PROJECTNAME=$CI_PROJECT_NAME \
      --build-arg PROJECTURL=$CI_PROJECT_URL \
      --build-arg COMMIT=$CI_COMMIT_SHA \
      -t registry.dbogatov.org/templates/latex-report/review/$CI_COMMIT_REF_NAME .
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.dbogatov.org
  - docker push registry.dbogatov.org/templates/latex-report/review/$CI_COMMIT_REF_NAME
  only:
    - branches
  except:
    - master
  tags:
  - shell

review:
  stage: review
  image: registry.dbogatov.org/dbogatov/setup-manager
  variables:
    GIT_STRATEGY: none
  script:
    - cd /
    - |
      ./generate-review-app.sh \
        $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME \
        registry.dbogatov.org/templates/latex-report/review/$CI_COMMIT_REF_NAME \
        $CI_BUILD_REF_NAME-$CI_PROJECT_NAME.review.dbogatov.org
    - kubectl --token=$K8STOKEN --server=https://k8sapi.dbogatov.org apply -R -f ./out
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: https://$CI_BUILD_REF_NAME-$CI_PROJECT_NAME.review.dbogatov.org
    on_stop: stop_review
  only:
    - branches
  except:
    - master
  tags:
  - docker

stop_review:
  stage: review
  image: registry.dbogatov.org/dbogatov/setup-manager
  script:
    - cd /
    - |
      ./generate-review-app.sh \
        $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME \
        registry.dbogatov.org/templates/latex-report/review/$CI_COMMIT_REF_NAME \
        $CI_BUILD_REF_NAME-$CI_PROJECT_NAME.review.dbogatov.org
    - kubectl --token=$K8STOKEN --server=https://k8sapi.dbogatov.org delete -R -f ./out
  variables:
    GIT_STRATEGY: none
  when: manual
  environment:
    name: review/$CI_BUILD_REF_NAME
    action: stop
  tags:
  - docker
