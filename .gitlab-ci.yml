stages:
  - sync
  - lint
  - build
  - test
  - build-review
  - review
  - release

# CHANGE ME!
variables:
  AUTHPASSWORD: "example" # change to "" (empty string) to disable authentication
  # username is always "review" (without quotes)
  CI_REF: &ref a5f020a655453149d99aebce9825cc93114eb233
  BUILD_ARGS: " | -d "

include:
  # VARIABLES
  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-report/variables.yml
  - project: "templates/ci-snippets"
    file: "latex-report/variables.yml"
    ref: *ref

  # SYNC
  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-report/merge-from-overleaf.yml
  - project: "templates/ci-snippets"
    file: "latex-report/merge-from-overleaf.yml"
    ref: *ref

  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-report/merge-to-overleaf.yml
  - project: "templates/ci-snippets"
    file: "latex-report/merge-to-overleaf.yml"
    ref: *ref

  # LINT
  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex/chktex.yml
  - project: "templates/ci-snippets"
    file: "latex/chktex.yml"
    ref: *ref

  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex/cspell.yml
  - project: "templates/ci-snippets"
    file: "latex/cspell.yml"
    ref: *ref

  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-report/metrics.yml
  - project: "templates/ci-snippets"
    file: "latex-report/metrics.yml"
    ref: *ref

  # BUILD
  # # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex/build.yml
  # - project: "templates/ci-snippets"
  #   file: "latex/build.yml"
  #   ref: *ref

  # TEST
  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-report/embedded-fonts.yml
  - project: "templates/ci-snippets"
    file: "latex-report/embedded-fonts.yml"
    ref: *ref

  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-report/check-links.yml
  - project: "templates/ci-snippets"
    file: "latex-report/check-links.yml"
    ref: *ref

  # BUILD REVIEW
  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-review-apps/build-review.yml
  - project: "templates/ci-snippets"
    file: "latex-review-apps/build-review.yml"
    ref: *ref

  # REVIEW
  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-review-apps/review.yml
  - project: "templates/ci-snippets"
    file: "latex-review-apps/review.yml"
    ref: *ref

  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex-review-apps/stop-review.yml
  - project: "templates/ci-snippets"
    file: "latex-review-apps/stop-review.yml"
    ref: *ref

  # RELEASE
  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex/artifacts.yml
  - project: "templates/ci-snippets"
    file: "latex/artifacts.yml"
    ref: *ref

  # https://git.dbogatov.org/templates/ci-snippets/-/blob/master/latex/pages.yml
  - project: "templates/ci-snippets"
    file: "latex/pages.yml"
    ref: *ref

build:
  image: dbogatov/docker-images:latex-latest
  stage: build
  script:
    - IFS='|' read -r -a args <<< "$BUILD_ARGS"
    - |
      if [ ${#args[@]} -eq 0 ]
      then
        args="${args:-' '}"
      fi
    - |
      for arg in "${args[@]}"
      do
          echo Building for "build.sh $arg"
          bash ./$LATEX_BUILD/build.sh $arg
          cp $LATEX_DIST/*.bbl .
      done
    - PAGES=$(wget -q -O - https://git.dbogatov.org/templates/ci-snippets/raw/master/page-count.sh | bash /dev/stdin ${PWD}/$LATEX_DIST/)
    - |
      echo "Max pages: $PAGES"
    - echo "PAGES_COUNT=$PAGES" >> pages-count.env
  artifacts:
    expire_in: 30 min
    paths:
      - "$LATEX_DIST/*.pdf"
      - $LATEX_DEFAULT_JOB.bbl
    reports:
      dotenv: pages-count.env
  rules:
    - if: "$DISABLE_REGULAR_PIPELINE"
      when: never
    - when: on_success
  tags:
    - docker

export-arxiv:
  stage: release
  image: dbogatov/docker-images:alpine-extras-latest
  variables:
    EXPORT_DIR: export-arxiv
  script:
    - rm -rf $LATEX_DIST
    - mkdir $EXPORT_DIR
    - cp -r $LATEX_SRC/* $EXPORT_DIR
    - cp $LATEX_DEFAULT_JOB.bbl $EXPORT_DIR/main.bbl
    - zip -r $EXPORT_DIR.zip $EXPORT_DIR
  dependencies:
    - build
  artifacts:
    paths:
      - $EXPORT_DIR.zip
  rules:
    - if: "$DISABLE_REGULAR_PIPELINE"
      when: never
    - when: on_success
  tags:
    - docker
