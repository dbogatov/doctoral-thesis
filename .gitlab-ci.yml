stages:
- lint
- build
- test
- build-review
- review
- release

# CHANGE ME!
variables:
  AUTHPASSWORD: "example" # change to "" (empty string) to disable authentication
  # username is always "review" (without quotes)
  CI_REF: &ref d2df7b37649b5cf3b65f3c4c873de99c99520761

include:
  # VARIABLES
  - project: 'templates/ci-snippets'
    file: 'latex-report/variables.yml'
    ref: *ref

  # BEFORE SCRIPT
  - project: 'templates/ci-snippets'
    file: 'variables.yml'
    ref: *ref

  # LINT
  - project: 'templates/ci-snippets'
    file: 'latex/chktex.yml'
    ref: *ref

  - project: 'templates/ci-snippets'
    file: 'latex/cspell.yml'
    ref: *ref

  - project: 'templates/ci-snippets'
    file: 'latex-report/metrics.yml'
    ref: *ref

  # BUILD
  - project: 'templates/ci-snippets'
    file: 'latex/build.yml'
    ref: *ref
    
  # TEST
  - project: 'templates/ci-snippets'
    file: 'latex-report/embedded-fonts.yml'
    ref: *ref
  
  - project: 'templates/ci-snippets'
    file: 'latex-report/check-links.yml'
    ref: *ref
  
  # BUILD REVIEW
  - project: 'templates/ci-snippets'
    file: 'latex-review-apps/build-review.yml'
    ref: *ref
  
  # REVIEW
  - project: 'templates/ci-snippets'
    file: 'latex-review-apps/review.yml'
    ref: *ref
    
  - project: 'templates/ci-snippets'
    file: 'latex-review-apps/stop-review.yml'
    ref: *ref
  
  # RELEASE
  - project: 'templates/ci-snippets'
    file: 'latex/artifacts.yml'
    ref: *ref

  - project: 'templates/ci-snippets'
    file: 'latex/pages.yml'
    ref: *ref

# ADJUSTMENTS

build-review:
  except: []

review:
  stage: review
  image: registry.dbogatov.org/dbogatov/setup-manager
  variables:
    GIT_STRATEGY: none
  script:
    - REPOLOWER=$(echo "$REPO" | tr '[:upper:]' '[:lower:]')
    - cd /
    - |
      ./generate-review-app.sh \
        $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME \
        registry.dbogatov.org/$REPOLOWER/review/$CI_COMMIT_REF_NAME \
        $CI_BUILD_REF_NAME-$CI_PROJECT_NAME.review.dbogatov.org \
        $AUTHPASSWORD
    - curl -s https://$TOKEN@token.dbogatov.org/config > config
    - export KUBECONFIG=$(pwd)/config
	- ls -la
	- echo $KUBECONFIG
	- cat $KUBECONFIG
    - kubectl --namespace=review delete secret $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-basic-auth || true
    - kubectl --namespace=review create secret generic $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-basic-auth --from-file=./out/auth
    - kubectl apply -R -f ./out
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: https://$CI_BUILD_REF_NAME-$CI_PROJECT_NAME.review.dbogatov.org
    on_stop: stop_review
  only:
    - branches
  tags:
  - docker

# review:
#   except: []

stop_review:
  except: []
